package io.yogurt.cli_mini_game.client.ui;

import com.fasterxml.jackson.databind.ObjectMapper;
import io.yogurt.cli_mini_game.client.handler.GameWebSocketClient;
import io.yogurt.cli_mini_game.client.service.HttpClientService;
import io.yogurt.cli_mini_game.client.util.UserSession;
import io.yogurt.cli_mini_game.common.game.dto.codequiz.CodeQuizRoomDTO;
import io.yogurt.cli_mini_game.common.game.dto.codequiz.JoinRoomRequest;
import io.yogurt.cli_mini_game.common.game.dto.codequiz.Language;
import io.yogurt.cli_mini_game.common.game.dto.codequiz.StartGameRequest;
import io.yogurt.cli_mini_game.common.game.dto.codequiz.SubmitAnswerRequest;
import io.yogurt.cli_mini_game.common.game.dto.GameTypeDTO;
import io.yogurt.cli_mini_game.common.user.dto.UserInfoResponse;

import java.net.URI;
import java.util.Arrays;
import java.util.List;
import java.util.Scanner;
import java.util.stream.Collectors;

/**
 * CLI 콘솔 사용자 인터페이스
 */
public class ConsoleUI {

    private final Scanner scanner;
    private final HttpClientService httpClient;
    private final UserSession userSession;
    private final ObjectMapper objectMapper;
    private GameWebSocketClient webSocketClient;
    private GameUI gameUI;
    private String currentRoomId;

    public ConsoleUI(String serverUrl) {
        this.scanner = new Scanner(System.in);
        this.httpClient = new HttpClientService(serverUrl);
        this.userSession = UserSession.getInstance();
        this.objectMapper = new ObjectMapper();
    }

    public void start() {
        System.out.println("=".repeat(60));
        System.out.println("CLI Mini Game - 코드 퀴즈");
        System.out.println("=".repeat(60));

        while (true) {
            if (!userSession.isLoggedIn()) {
                showLoginMenu();
            } else {
                showMainMenu();
            }
        }
    }

    private void showLoginMenu() {
        System.out.println("\n1. 로그인");
        System.out.println("2. 회원가입");
        System.out.println("3. 종료");
        System.out.print("선택: ");

        String choice = scanner.nextLine().trim();

        switch (choice) {
            case "1":
                login();
                break;
            case "2":
                register();
                break;
            case "3":
                System.out.println("프로그램을 종료합니다.");
                System.exit(0);
                break;
            default:
                System.out.println("잘못된 선택입니다.");
        }
    }

    private void login() {
        System.out.print("아이디: ");
        String username = scanner.nextLine().trim();
        System.out.print("비밀번호: ");
        String password = scanner.nextLine().trim();

        try {
            UserInfoResponse userInfo = httpClient.login(username, password);
            userSession.login(userInfo);
            System.out.println("\n로그인 성공! 환영합니다, " + userInfo.nickname() + "님!");
        } catch (Exception e) {
            System.err.println("로그인 실패: " + e.getMessage());
        }
    }

    private void register() {
        System.out.print("아이디: ");
        String username = scanner.nextLine().trim();
        System.out.print("비밀번호: ");
        String password = scanner.nextLine().trim();
        System.out.print("닉네임: ");
        String nickname = scanner.nextLine().trim();

        try {
            UserInfoResponse userInfo = httpClient.register(username, password, nickname);
            System.out.println("\n회원가입 성공!");
            userSession.login(userInfo);
            System.out.println("자동으로 로그인되었습니다. 환영합니다, " + userInfo.nickname() + "님!");
        } catch (Exception e) {
            System.err.println("회원가입 실패: " + e.getMessage());
        }
    }

    private void showMainMenu() {
        System.out.println("\n--- 메인 메뉴 ---");
        System.out.println("1. 게임 선택");
        System.out.println("2. 로그아웃");
        System.out.println("3. 종료");
        System.out.print("선택: ");

        String choice = scanner.nextLine().trim();

        switch (choice) {
            case "1":
                selectGame();
                break;
            case "2":
                logout();
                break;
            case "3":
                System.out.println("프로그램을 종료합니다.");
                System.exit(0);
                break;
            default:
                System.out.println("잘못된 선택입니다.");
        }
    }

    private void selectGame() {
        try {
            List<GameTypeDTO> gameTypes = httpClient.getGameTypes();

            System.out.println("\n--- 게임 선택 ---");
            for (int i = 0; i < gameTypes.size(); i++) {
                GameTypeDTO gameType = gameTypes.get(i);
                System.out.println((i + 1) + ". " + gameType.name() + " - " + gameType.description());
            }
            System.out.println("0. 돌아가기");
            System.out.print("선택: ");

            String choice = scanner.nextLine().trim();

            if (choice.equals("0")) {
                return;
            }

            int index = Integer.parseInt(choice) - 1;
            if (index >= 0 && index < gameTypes.size()) {
                GameTypeDTO selectedGame = gameTypes.get(index);
                if (selectedGame.code().equals("CODE_QUIZ")) {
                    showCodeQuizMenu();
                }
            } else {
                System.out.println("잘못된 선택입니다.");
            }
        } catch (Exception e) {
            System.err.println("게임 목록 조회 실패: " + e.getMessage());
        }
    }

    private void showCodeQuizMenu() {
        System.out.println("\n--- 코드 퀴즈 ---");
        System.out.println("1. 방 찾기");
        System.out.println("2. 방 만들기");
        System.out.println("0. 돌아가기");
        System.out.print("선택: ");

        String choice = scanner.nextLine().trim();

        switch (choice) {
            case "1":
                findRoom();
                break;
            case "2":
                createRoom();
                break;
            case "0":
                break;
            default:
                System.out.println("잘못된 선택입니다.");
        }
    }

    private void findRoom() {
        try {
            List<CodeQuizRoomDTO> rooms = httpClient.getCodeQuizRooms();

            if (rooms.isEmpty()) {
                System.out.println("\n대기 중인 방이 없습니다.");
                return;
            }

            System.out.println("\n--- 대기 중인 방 목록 ---");
            for (int i = 0; i < rooms.size(); i++) {
                CodeQuizRoomDTO room = rooms.get(i);
                System.out.printf("%d. %s [%d/%d]\n",
                        i + 1, room.roomName(), room.currentPlayers(), room.maxPlayers());
            }
            System.out.println("0. 돌아가기");
            System.out.print("입장할 방 선택: ");

            String choice = scanner.nextLine().trim();

            if (choice.equals("0")) {
                return;
            }

            int index = Integer.parseInt(choice) - 1;
            if (index >= 0 && index < rooms.size()) {
                CodeQuizRoomDTO selectedRoom = rooms.get(index);
                joinRoom(selectedRoom.roomId());
            } else {
                System.out.println("잘못된 선택입니다.");
            }
        } catch (Exception e) {
            System.err.println("방 목록 조회 실패: " + e.getMessage());
        }
    }

    private void createRoom() {
        try {
            System.out.print("방 이름: ");
            String roomName = scanner.nextLine().trim();

            System.out.print("최대 플레이어 수 (2-4): ");
            int maxPlayers = Integer.parseInt(scanner.nextLine().trim());

            System.out.println("언어 선택:");
            System.out.println("1. Java");
            System.out.println("2. Python");
            System.out.print("선택: ");
            String langChoice = scanner.nextLine().trim();

            Language language = langChoice.equals("2") ? Language.PYTHON : Language.JAVA;

            CodeQuizRoomDTO room = httpClient.createCodeQuizRoom(roomName, maxPlayers, language);
            System.out.println("\n방이 생성되었습니다: " + room.roomName());

            joinRoom(room.roomId());
        } catch (Exception e) {
            System.err.println("방 생성 실패: " + e.getMessage());
        }
    }

    private void joinRoom(String roomId) {
        try {
            currentRoomId = roomId;

            // WebSocket 연결
            gameUI = new GameUI();
            String wsUrl = "ws://localhost:8080/game-websocket";
            webSocketClient = new GameWebSocketClient(new URI(wsUrl), gameUI);

            System.out.println("\n게임 서버에 연결 중...");
            webSocketClient.connectBlocking();

            // 잠시 대기 (CONNECTED 프레임 수신 대기)
            Thread.sleep(500);

            // 방 구독
            webSocketClient.subscribe("/topic/code-quiz/room/" + roomId, "room-" + roomId);

            // 방 입장 메시지 전송
            JoinRoomRequest joinRequest = new JoinRoomRequest(roomId, userSession.getNickname());
            String json = objectMapper.writeValueAsString(joinRequest);
            webSocketClient.sendMessage("/app/code-quiz/join", json);

            System.out.println("방에 입장했습니다!");

            // 대기실
            waitingRoom();

        } catch (Exception e) {
            System.err.println("방 입장 실패: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void waitingRoom() {
        System.out.println("\n--- 대기실 ---");
        System.out.println("게임 시작을 기다리는 중...");
        System.out.println("명령어: start (게임 시작), leave (나가기)");

        while (webSocketClient.isConnected() && !gameUI.isGameInProgress()) {
            System.out.print("> ");
            String command = scanner.nextLine().trim();

            if (command.equalsIgnoreCase("start")) {
                startGame();
            } else if (command.equalsIgnoreCase("leave")) {
                leaveRoom();
                return;
            }
        }

        // 게임 시작되면 플레이
        if (gameUI.isGameInProgress()) {
            playGame();
        }
    }

    private void startGame() {
        try {
            StartGameRequest startRequest = new StartGameRequest(currentRoomId);
            String json = objectMapper.writeValueAsString(startRequest);
            webSocketClient.sendMessage("/app/code-quiz/start", json);
        } catch (Exception e) {
            System.err.println("게임 시작 실패: " + e.getMessage());
        }
    }

    private void playGame() {
        while (webSocketClient.isConnected() && gameUI.isGameInProgress()) {
            if (!gameUI.isWaitingForNextQuestion()) {
                String input = scanner.nextLine().trim();

                if (input.equalsIgnoreCase("quit")) {
                    leaveRoom();
                    return;
                }

                try {
                    // 쉼표로 구분된 라인 번호 파싱
                    List<Integer> lineNumbers = Arrays.stream(input.split(","))
                            .map(String::trim)
                            .map(Integer::parseInt)
                            .collect(Collectors.toList());

                    submitAnswer(lineNumbers);
                } catch (NumberFormatException e) {
                    System.out.println("올바른 숫자를 입력하세요.");
                }
            } else {
                // 다음 문제 대기 중
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    break;
                }
            }
        }

        // 게임 종료 후 입력 대기
        if (!gameUI.isGameInProgress()) {
            scanner.nextLine();
            leaveRoom();
        }
    }

    private void submitAnswer(List<Integer> lineNumbers) {
        try {
            SubmitAnswerRequest answerRequest = new SubmitAnswerRequest(
                    currentRoomId,
                    lineNumbers
            );
            String json = objectMapper.writeValueAsString(answerRequest);
            webSocketClient.sendMessage("/app/code-quiz/answer", json);
        } catch (Exception e) {
            System.err.println("답안 제출 실패: " + e.getMessage());
        }
    }

    private void leaveRoom() {
        if (webSocketClient != null && webSocketClient.isConnected()) {
            webSocketClient.disconnect();
        }
        currentRoomId = null;
        System.out.println("방을 나갔습니다.");
    }

    private void logout() {
        if (webSocketClient != null && webSocketClient.isConnected()) {
            webSocketClient.disconnect();
        }
        userSession.logout();
        System.out.println("로그아웃되었습니다.");
    }
}
